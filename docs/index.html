<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Level Up Community Commands</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f5f5f5;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        .stats {
            background: white;
            padding: 2rem;
            margin: 2rem 0;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 2rem;
            text-align: center;
        }

        .stat-item h3 {
            font-size: 2rem;
            color: #667eea;
            margin-bottom: 0.5rem;
        }

        .search-section {
            background: white;
            padding: 2rem;
            margin: 2rem 0;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .search-box {
            width: 100%;
            padding: 1rem;
            font-size: 1.1rem;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .search-box:focus {
            outline: none;
            border-color: #667eea;
        }

        .filters {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }

        .filter-select {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
        }

        .collections-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 2rem;
            margin: 2rem 0;
        }

        .collection-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .collection-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        .collection-header {
            padding: 1.5rem;
            border-bottom: 1px solid #eee;
        }

        .collection-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #333;
        }

        .collection-author {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .collection-description {
            color: #555;
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .collection-meta {
            padding: 1rem 1.5rem;
            background: #f8f9fa;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            color: #666;
        }

        .collection-stats {
            display: flex;
            gap: 1rem;
        }

        .collection-actions {
            padding: 1.5rem;
            display: flex;
            gap: 0.5rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.2s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #666;
            border: 1px solid #ddd;
        }

        .btn-secondary:hover {
            background: #e9ecef;
        }

        .tags {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-top: 0.5rem;
        }

        .tag {
            background: #e9ecef;
            color: #495057;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.8rem;
        }

        .auto-checked-badge {
            background: #28a745;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: #666;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 1rem;
            border-radius: 4px;
            margin: 1rem 0;
        }

        .footer {
            background: #333;
            color: white;
            text-align: center;
            padding: 2rem 0;
            margin-top: 4rem;
        }

        .footer a {
            color: #667eea;
            text-decoration: none;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }

            .collections-grid {
                grid-template-columns: 1fr;
            }

            .filters {
                flex-direction: column;
            }

            .collection-meta {
                flex-direction: column;
                gap: 0.5rem;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="container">
            <h1>üöÄ Level Up Community Commands</h1>
            <p>Discover and share custom Dynamics 365 command collections</p>
        </div>
    </header>

    <main class="container">
        <!-- Statistics Section -->
        <section class="stats">
            <div class="stat-item">
                <h3 id="total-collections">-</h3>
                <p>Collections</p>
            </div>
            <div class="stat-item">
                <h3 id="total-commands">-</h3>
                <p>Commands</p>
            </div>
            <div class="stat-item">
                <h3 id="total-users">-</h3>
                <p>Contributors</p>
            </div>
            <div class="stat-item">
                <h3 id="auto-checked">-</h3>
                <p>Auto-Checked</p>
            </div>
        </section>

        <!-- Search and Filter Section -->
        <section class="search-section">
            <input type="text" class="search-box" id="search-box" placeholder="Search collections by name, description, or author...">

            <div class="filters">
                <select class="filter-select" id="category-filter">
                    <option value="">All Categories</option>
                </select>

                <select class="filter-select" id="author-filter">
                    <option value="">All Authors</option>
                </select>

                <select class="filter-select" id="sort-filter">
                    <option value="newest">Newest First</option>
                    <option value="oldest">Oldest First</option>
                    <option value="name">Name A-Z</option>
                    <option value="commands">Most Commands</option>
                </select>
            </div>
        </section>

        <!-- Collections Grid -->
        <section class="collections-grid" id="collections-grid">
            <div class="loading">Loading collections...</div>
        </section>
    </main>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 Level Up Community. Made with ‚ù§Ô∏è for the Dynamics 365 community.</p>
            <p><a href="https://github.com/rajyraman/level-up-community-commands">View on GitHub</a> |
               <a href="https://github.com/rajyraman/level-up-vnext">Level Up Extension</a></p>
        </div>
    </footer>

    <script>
        // Global state
        let allCollections = [];
        let filteredCollections = [];

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            loadCollections();
            setupEventListeners();
        });

        // Setup event listeners
        function setupEventListeners() {
            const searchBox = document.getElementById('search-box');
            const categoryFilter = document.getElementById('category-filter');
            const authorFilter = document.getElementById('author-filter');
            const sortFilter = document.getElementById('sort-filter');

            searchBox.addEventListener('input', filterCollections);
            categoryFilter.addEventListener('change', filterCollections);
            authorFilter.addEventListener('change', filterCollections);
            sortFilter.addEventListener('change', filterCollections);
        }

        // Load collections from the API/index
        async function loadCollections() {
            try {
                const response = await fetch('./collections/index.json');
                const data = await response.json();

                updateStatistics(data);
                populateFilters(data);

                allCollections = data.recentCollections || [];
                filteredCollections = [...allCollections];

                renderCollections();
            } catch (error) {
                console.error('Failed to load collections:', error);
                showError('Failed to load collections. Please try again later.');
            }
        }

        // Update statistics
        function updateStatistics(data) {
            document.getElementById('total-collections').textContent = data.totalCollections || 0;
            document.getElementById('total-commands').textContent = data.totalCommands || 0;
            document.getElementById('total-users').textContent = data.totalUsers || 0;

            // Count auto-checked collections
            const autoChecked = (data.recentCollections || []).filter(c => c.autoApproved !== false).length;
            document.getElementById('auto-checked').textContent = autoChecked;
        }

        // Populate filter dropdowns
        function populateFilters(data) {
            const categoryFilter = document.getElementById('category-filter');
            const authorFilter = document.getElementById('author-filter');

            // Categories
            Object.keys(data.categories || {}).forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = `${category} (${data.categories[category]})`;
                categoryFilter.appendChild(option);
            });

            // Authors
            const authors = [...new Set((data.recentCollections || []).map(c => c.displayName || c.username))];
            authors.sort().forEach(author => {
                const option = document.createElement('option');
                option.value = author;
                option.textContent = author;
                authorFilter.appendChild(option);
            });
        }

        // Filter collections
        function filterCollections() {
            const searchTerm = document.getElementById('search-box').value.toLowerCase();
            const categoryFilter = document.getElementById('category-filter').value;
            const authorFilter = document.getElementById('author-filter').value;
            const sortFilter = document.getElementById('sort-filter').value;

            filteredCollections = allCollections.filter(collection => {
                const matchesSearch = !searchTerm ||
                    collection.name.toLowerCase().includes(searchTerm) ||
                    collection.description.toLowerCase().includes(searchTerm) ||
                    (collection.displayName || collection.username).toLowerCase().includes(searchTerm);

                const matchesCategory = !categoryFilter || collection.category === categoryFilter;
                const matchesAuthor = !authorFilter ||
                    (collection.displayName || collection.username) === authorFilter;

                return matchesSearch && matchesCategory && matchesAuthor;
            });

            // Sort collections
            filteredCollections.sort((a, b) => {
                switch (sortFilter) {
                    case 'oldest':
                        return new Date(a.submittedAt) - new Date(b.submittedAt);
                    case 'name':
                        return a.name.localeCompare(b.name);
                    case 'commands':
                        return b.commandCount - a.commandCount;
                    case 'newest':
                    default:
                        return new Date(b.submittedAt) - new Date(a.submittedAt);
                }
            });

            renderCollections();
        }

        // Render collections
        function renderCollections() {
            const grid = document.getElementById('collections-grid');

            if (filteredCollections.length === 0) {
                grid.innerHTML = '<div class="loading">No collections found matching your criteria.</div>';
                return;
            }

            grid.innerHTML = filteredCollections.map(collection => createCollectionCard(collection)).join('');
        }

        // Create collection card HTML
        function createCollectionCard(collection) {
            const submittedDate = new Date(collection.submittedAt).toLocaleDateString();
            const tags = (collection.tags || []).map(tag => `<span class="tag">${tag}</span>`).join('');
            const autoCheckedBadge = collection.autoApproved !== false ?
                '<span class="auto-checked-badge">‚úÖ Auto-Checked</span>' : '';

            return `
                <div class="collection-card">
                    <div class="collection-header">
                        <h3 class="collection-title">${collection.name}</h3>
                        <div class="collection-author">
                            by ${collection.displayName || collection.username}
                        </div>
                        <p class="collection-description">${collection.description || 'No description available'}</p>
                        <div class="tags">
                            ${tags}
                            ${autoCheckedBadge}
                        </div>
                    </div>

                    <div class="collection-meta">
                        <div class="collection-stats">
                            <span>${collection.commandCount} commands</span>
                            <span>üìÖ ${submittedDate}</span>
                        </div>
                        <div>
                            üìÇ ${collection.category}
                        </div>
                    </div>

                    <div class="collection-actions">
                        <button class="btn btn-primary" onclick="copyToClipboard('${collection.username}', '${collection.fileName}')">
                            üìã Copy Commands
                        </button>
                        <a href="./collections/${collection.username}/" class="btn btn-secondary" target="_blank">
                            üë§ View Profile
                        </a>
                    </div>
                </div>
            `;
        }

        // Copy collection commands to clipboard
        async function copyToClipboard(username, fileName) {
            try {
                const response = await fetch(`./collections/${username}/collections/${fileName}`);
                const collection = await response.json();

                const levelUpFormat = {
                    version: "1.0.0",
                    exportedAt: Date.now(),
                    commands: collection.commands.map(cmd => ({
                        name: cmd.name,
                        description: cmd.description,
                        code: cmd.code,
                        icon: cmd.icon
                    }))
                };

                await navigator.clipboard.writeText(JSON.stringify(levelUpFormat, null, 2));

                // Show success feedback
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = '‚úÖ Copied!';
                button.style.background = '#28a745';

                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = '';
                }, 2000);

            } catch (error) {
                console.error('Failed to copy to clipboard:', error);
                alert('Failed to copy commands. Please try again.');
            }
        }

        // Show error message
        function showError(message) {
            const grid = document.getElementById('collections-grid');
            grid.innerHTML = `<div class="error">${message}</div>`;
        }
    </script>
</body>
</html>
