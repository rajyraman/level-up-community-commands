<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Level Up Community Commands</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif']
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 text-gray-900">
    <!-- Header -->
    <header class="bg-gradient-to-br from-indigo-600 to-purple-700 text-white py-12 text-center">
        <div class="max-w-7xl mx-auto px-4">
            <h1 class="text-5xl font-bold mb-3 tracking-tight">üöÄ Level Up Community Commands</h1>
            <p class="text-xl opacity-95">Discover and share custom Dynamics 365 command collections</p>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4">
        <!-- Statistics Section -->
        <section class="bg-white p-10 my-12 rounded-2xl shadow-lg border border-gray-100 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-10 text-center">
            <div>
                <h3 id="total-collections" class="text-4xl font-bold text-indigo-600 mb-2">-</h3>
                <p class="text-gray-500 font-medium">Collections</p>
            </div>
            <div>
                <h3 id="total-commands" class="text-4xl font-bold text-indigo-600 mb-2">-</h3>
                <p class="text-gray-500 font-medium">Commands</p>
            </div>
            <div>
                <h3 id="total-users" class="text-4xl font-bold text-indigo-600 mb-2">-</h3>
                <p class="text-gray-500 font-medium">Contributors</p>
            </div>
            <div>
                <h3 id="auto-checked" class="text-4xl font-bold text-indigo-600 mb-2">-</h3>
                <p class="text-gray-500 font-medium">ü§ñ Auto-Verified</p>
            </div>
        </section>

        <!-- Search and Filter Section -->
        <section class="bg-white p-10 my-12 rounded-2xl shadow-lg border border-gray-100">
            <input type="text" id="search-box"
                   class="w-full p-5 text-base border-2 border-gray-200 rounded-xl mb-6 bg-gray-50 transition-colors focus:outline-none focus:border-indigo-600 focus:bg-white"
                   placeholder="Search collections by name, description, or author...">

            <div class="flex gap-4 flex-wrap">
                <select id="category-filter" class="p-3 border-2 border-gray-200 rounded-lg bg-gray-50 text-sm transition-colors focus:outline-none focus:border-indigo-600 focus:bg-white">
                    <option value="">All Categories</option>
                </select>
                <select id="author-filter" class="p-3 border-2 border-gray-200 rounded-lg bg-gray-50 text-sm transition-colors focus:outline-none focus:border-indigo-600 focus:bg-white">
                    <option value="">All Authors</option>
                </select>
                <select id="sort-filter" class="p-3 border-2 border-gray-200 rounded-lg bg-gray-50 text-sm transition-colors focus:outline-none focus:border-indigo-600 focus:bg-white">
                    <option value="newest">Newest First</option>
                    <option value="oldest">Oldest First</option>
                    <option value="name">Name A-Z</option>
                    <option value="commands">Most Commands</option>
                </select>
            </div>
        </section>

        <!-- Collections Grid -->
        <section id="collections-grid" class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6 my-12">
            <div class="text-center py-12 text-gray-500">Loading collections...</div>
        </section>
    </main>

    <!-- Commands Modal -->
    <div id="commandsModal" class="hidden fixed inset-0 z-50 bg-black bg-opacity-50 backdrop-blur-sm">
        <div class="bg-white my-20 mx-auto p-0 rounded-2xl w-11/12 max-w-4xl max-h-4/5 overflow-hidden shadow-2xl">
            <div class="p-8 border-b border-gray-200 flex justify-between items-center">
                <h2 id="modalTitle" class="text-2xl font-bold text-gray-900">Collection Commands</h2>
                <button onclick="closeModal()" class="text-3xl font-bold text-gray-500 hover:text-gray-900 hover:bg-gray-100 p-2 rounded-lg transition-all">√ó</button>
            </div>
            <div id="modalBody" class="p-8 max-h-96 overflow-y-auto">
                <!-- Commands will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-800 text-gray-300 text-center py-12 mt-16">
        <div class="max-w-7xl mx-auto px-4">
            <p class="mb-2">&copy; 2025 Level Up Community. Made with ‚ù§Ô∏è for the Dynamics 365 community.</p>
            <p>
                <a href="https://github.com/rajyraman/level-up-community-commands" class="text-indigo-400 hover:underline font-medium">View on GitHub</a> |
                <a href="https://github.com/rajyraman/level-up-vnext" class="text-indigo-400 hover:underline font-medium">Level Up Extension</a>
            </p>
        </div>
    </footer>

    <!-- Collection Card Template -->
    <template id="collection-card-template">
        <div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden transition-all duration-300 hover:-translate-y-1 hover:shadow-xl hover:border-gray-200 flex flex-col h-full">
            <div class="p-6 flex-grow">
                <h3 class="collection-title text-xl font-bold mb-2 text-gray-900 leading-tight"></h3>
                <div class="collection-author text-gray-500 text-sm mb-3 font-medium"></div>
                <p class="collection-description text-gray-600 text-sm leading-relaxed mb-4"></p>
                <div class="collection-tags flex gap-2 flex-wrap mt-auto"></div>
            </div>

            <div class="px-6 py-4 bg-gray-50 border-t border-gray-100 flex justify-between items-center text-xs text-gray-500">
                <div class="collection-stats flex gap-4 items-center"></div>
            </div>

            <div class="p-6 pt-4 flex gap-2 flex-wrap">
                <button class="copy-btn flex-1 min-w-32 px-4 py-2.5 bg-indigo-600 text-white rounded-lg text-xs font-semibold transition-all duration-200 hover:bg-indigo-700 hover:-translate-y-0.5 flex items-center justify-center gap-1.5">
                    üìã Copy Commands
                </button>
                <button class="view-btn flex-1 min-w-32 px-4 py-2.5 bg-transparent text-indigo-600 border-2 border-indigo-600 rounded-lg text-xs font-semibold transition-all duration-200 hover:bg-indigo-600 hover:text-white hover:-translate-y-0.5 flex items-center justify-center gap-1.5">
                    üëÅÔ∏è View Commands
                </button>
                <a class="profile-link flex-1 min-w-32 px-4 py-2.5 bg-gray-100 text-gray-700 border border-gray-300 rounded-lg text-xs font-semibold transition-all duration-200 hover:bg-gray-200 hover:-translate-y-0.5 flex items-center justify-center gap-1.5 no-underline" target="_blank">
                    üêô View Profile
                </a>
            </div>
        </div>
    </template>

    <!-- Command Item Template -->
    <template id="command-item-template">
        <div class="border border-gray-200 rounded-lg mb-4 overflow-hidden">
            <div class="bg-gray-50 p-4 border-b border-gray-200">
                <div class="command-name font-semibold text-gray-900 mb-1"></div>
                <div class="command-description text-gray-600 text-sm"></div>
            </div>
            <div class="command-code p-4 bg-gray-800 text-gray-100 font-mono text-xs leading-relaxed whitespace-pre-wrap overflow-x-auto"></div>
        </div>
    </template>

    <script>
        // Global state
        let allCollections = [];
        let filteredCollections = [];

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            loadCollections();
            setupEventListeners();
        });

        // Setup event listeners
        function setupEventListeners() {
            const searchBox = document.getElementById('search-box');
            const categoryFilter = document.getElementById('category-filter');
            const authorFilter = document.getElementById('author-filter');
            const sortFilter = document.getElementById('sort-filter');

            searchBox.addEventListener('input', filterCollections);
            categoryFilter.addEventListener('change', filterCollections);
            authorFilter.addEventListener('change', filterCollections);
            sortFilter.addEventListener('change', filterCollections);
        }

        // Load collections from the API/index
        async function loadCollections() {
            try {
                const response = await fetch('../collections/index.json');
                const data = await response.json();

                updateStatistics(data);
                populateFilters(data);

                allCollections = data.recentCollections || [];
                filteredCollections = [...allCollections];

                renderCollections();
            } catch (error) {
                console.error('Failed to load collections:', error);
                showError('Failed to load collections. Please try again later.');
            }
        }

        // Update statistics
        function updateStatistics(data) {
            document.getElementById('total-collections').textContent = data.totalCollections || 0;
            document.getElementById('total-commands').textContent = data.totalCommands || 0;
            document.getElementById('total-users').textContent = data.totalUsers || 0;

            // Count auto-checked collections
            const autoChecked = (data.recentCollections || []).filter(c => c.autoApproved !== false).length;
            document.getElementById('auto-checked').textContent = autoChecked;
        }

        // Populate filter dropdowns
        function populateFilters(data) {
            const categoryFilter = document.getElementById('category-filter');
            const authorFilter = document.getElementById('author-filter');

            // Categories
            Object.keys(data.categories || {}).forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = `${category} (${data.categories[category]})`;
                categoryFilter.appendChild(option);
            });

            // Authors
            const authors = [...new Set((data.recentCollections || []).map(c => c.displayName || c.username))];
            authors.sort().forEach(author => {
                const option = document.createElement('option');
                option.value = author;
                option.textContent = author;
                authorFilter.appendChild(option);
            });
        }

        // Filter by tag (category or regular tag)
        function filterByTag(tag) {
            // Set the search box to the tag value
            document.getElementById('search-box').value = tag;

            // Clear other filters
            document.getElementById('category-filter').value = '';
            document.getElementById('author-filter').value = '';

            // Trigger filtering
            filterCollections();
        }

        // Filter collections
        function filterCollections() {
            const searchTerm = document.getElementById('search-box').value.toLowerCase();
            const categoryFilter = document.getElementById('category-filter').value;
            const authorFilter = document.getElementById('author-filter').value;
            const sortFilter = document.getElementById('sort-filter').value;

            filteredCollections = allCollections.filter(collection => {
                const matchesSearch = !searchTerm ||
                    collection.name.toLowerCase().includes(searchTerm) ||
                    collection.description.toLowerCase().includes(searchTerm) ||
                    (collection.displayName || collection.username).toLowerCase().includes(searchTerm) ||
                    collection.category.toLowerCase().includes(searchTerm) ||
                    (collection.tags || []).some(tag => tag.toLowerCase().includes(searchTerm));

                const matchesCategory = !categoryFilter || collection.category === categoryFilter;
                const matchesAuthor = !authorFilter ||
                    (collection.displayName || collection.username) === authorFilter;

                return matchesSearch && matchesCategory && matchesAuthor;
            });

            // Sort collections
            filteredCollections.sort((a, b) => {
                switch (sortFilter) {
                    case 'oldest':
                        return new Date(a.submittedAt) - new Date(b.submittedAt);
                    case 'name':
                        return a.name.localeCompare(b.name);
                    case 'commands':
                        return b.commandCount - a.commandCount;
                    case 'newest':
                    default:
                        return new Date(b.submittedAt) - new Date(a.submittedAt);
                }
            });

            renderCollections();
        }

        // Render collections
        function renderCollections() {
            const grid = document.getElementById('collections-grid');

            if (filteredCollections.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center py-12 text-gray-500">No collections found matching your criteria.</div>';
                return;
            }

            grid.innerHTML = '';
            filteredCollections.forEach(collection => {
                const card = createCollectionCard(collection);
                grid.appendChild(card);
            });
        }

        // Create collection card from template
        function createCollectionCard(collection) {
            const template = document.getElementById('collection-card-template');
            const card = template.content.cloneNode(true);

            // Populate data
            const submittedDate = new Date(collection.submittedAt).toLocaleDateString();

            card.querySelector('.collection-title').textContent = collection.name;
            card.querySelector('.collection-author').textContent = `by ${collection.displayName || collection.username}`;
            card.querySelector('.collection-description').textContent = collection.description || 'No description available';

            // Add tags and category as clickable items
            const tagsContainer = card.querySelector('.collection-tags');

            // Add category as a clickable tag
            const categoryTag = document.createElement('span');
            categoryTag.className = 'bg-amber-500 text-white px-3 py-1.5 rounded-md text-xs font-semibold cursor-pointer hover:bg-amber-600 transition-colors';
            categoryTag.textContent = `üìÇ ${collection.category}`;
            categoryTag.addEventListener('click', () => filterByTag(collection.category));
            tagsContainer.appendChild(categoryTag);

            // Add regular tags as clickable items
            (collection.tags || []).forEach(tag => {
                const tagSpan = document.createElement('span');
                tagSpan.className = 'bg-indigo-100 text-indigo-800 px-3 py-1.5 rounded-md text-xs font-semibold cursor-pointer hover:bg-indigo-200 transition-colors';
                tagSpan.textContent = tag;
                tagSpan.addEventListener('click', () => filterByTag(tag));
                tagsContainer.appendChild(tagSpan);
            });

            // Add robot badge if auto-approved (non-clickable)
            if (collection.autoApproved !== false) {
                const robotBadge = document.createElement('span');
                robotBadge.className = 'bg-emerald-500 text-white px-3 py-1.5 rounded-md text-xs font-semibold flex items-center gap-1';
                robotBadge.textContent = 'ü§ñ Auto-Verified';
                tagsContainer.appendChild(robotBadge);
            }

            // Add stats
            const statsContainer = card.querySelector('.collection-stats');
            statsContainer.innerHTML = `
                <span class="flex items-center gap-1">üìä ${collection.commandCount} commands</span>
                <span class="flex items-center gap-1">üìÖ ${submittedDate}</span>
            `;

            // Add event listeners for buttons
            const copyBtn = card.querySelector('.copy-btn');
            const viewBtn = card.querySelector('.view-btn');
            const profileLink = card.querySelector('.profile-link');

            copyBtn.addEventListener('click', () => copyToClipboard(collection.username, collection.fileName, copyBtn));
            viewBtn.addEventListener('click', () => viewCommands(collection.username, collection.fileName, collection.name));
            profileLink.href = `https://github.com/${collection.username}`;

            return card;
        }

        // Copy collection commands to clipboard
        async function copyToClipboard(username, fileName, clickedButton) {
            try {
                // Ensure the window is focused first
                window.focus();

                const response = await fetch(`../collections/${username}/collections/${fileName}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const collection = await response.json();

                const levelUpFormat = {
                    version: "1.0.0",
                    exportedAt: Date.now(),
                    commands: collection.commands.map(cmd => ({
                        name: cmd.name,
                        description: cmd.description,
                        code: cmd.code,
                        icon: cmd.icon
                    }))
                };

                const jsonText = JSON.stringify(levelUpFormat, null, 2);

                // Try modern clipboard API first
                if (navigator.clipboard && window.isSecureContext) {
                    await navigator.clipboard.writeText(jsonText);
                } else {
                    // Fallback for older browsers or non-HTTPS
                    const textArea = document.createElement('textarea');
                    textArea.value = jsonText;
                    textArea.style.position = 'fixed';
                    textArea.style.left = '-999999px';
                    textArea.style.top = '-999999px';
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();

                    try {
                        document.execCommand('copy');
                    } catch (err) {
                        throw new Error('Clipboard copy failed');
                    } finally {
                        document.body.removeChild(textArea);
                    }
                }

                // Show success feedback
                if (clickedButton) {
                    const originalText = clickedButton.innerHTML;
                    clickedButton.innerHTML = '‚úÖ Copied!';
                    clickedButton.className = clickedButton.className.replace('bg-indigo-600 hover:bg-indigo-700', 'bg-emerald-500');
                    clickedButton.disabled = true;

                    setTimeout(() => {
                        clickedButton.innerHTML = originalText;
                        clickedButton.className = clickedButton.className.replace('bg-emerald-500', 'bg-indigo-600 hover:bg-indigo-700');
                        clickedButton.disabled = false;
                    }, 2000);
                }

            } catch (error) {
                console.error('Failed to copy to clipboard:', error);

                // Show error feedback
                if (clickedButton) {
                    const originalText = clickedButton.innerHTML;
                    clickedButton.innerHTML = '‚ùå Error';
                    clickedButton.className = clickedButton.className.replace('bg-indigo-600 hover:bg-indigo-700', 'bg-red-500');

                    setTimeout(() => {
                        clickedButton.innerHTML = originalText;
                        clickedButton.className = clickedButton.className.replace('bg-red-500', 'bg-indigo-600 hover:bg-indigo-700');
                    }, 2000);
                }

                // Show detailed error to user
                alert(`Failed to copy commands: ${error.message}\n\nPlease ensure:\n- Your browser supports clipboard access\n- The page is served over HTTPS (for production)\n- You clicked directly on the button`);
            }
        }

        // View commands in modal
        async function viewCommands(username, fileName, collectionName) {
            try {
                const response = await fetch(`../collections/${username}/collections/${fileName}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const collection = await response.json();

                document.getElementById('modalTitle').textContent = `${collectionName} - Commands`;

                const modalBody = document.getElementById('modalBody');
                modalBody.innerHTML = '';

                collection.commands.forEach(cmd => {
                    const commandItem = createCommandItem(cmd);
                    modalBody.appendChild(commandItem);
                });

                document.getElementById('commandsModal').classList.remove('hidden');

            } catch (error) {
                console.error('Failed to load commands:', error);
                alert(`Failed to load commands: ${error.message}`);
            }
        }

        // Create command item from template
        function createCommandItem(cmd) {
            const template = document.getElementById('command-item-template');
            const item = template.content.cloneNode(true);

            item.querySelector('.command-name').textContent = `${cmd.icon || 'üìÑ'} ${cmd.name}`;
            item.querySelector('.command-description').textContent = cmd.description;
            item.querySelector('.command-code').textContent = cmd.code;

            return item;
        }

        // Close modal
        function closeModal() {
            document.getElementById('commandsModal').classList.add('hidden');
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('commandsModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // Close modal with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeModal();
            }
        });

        // Show error message
        function showError(message) {
            const grid = document.getElementById('collections-grid');
            grid.innerHTML = `<div class="col-span-full bg-red-100 text-red-800 p-4 rounded-lg">${message}</div>`;
        }
    </script>
</body>
</html>
