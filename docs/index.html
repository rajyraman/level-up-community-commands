<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="color-scheme" content="light dark" />
    <meta name="theme-color" content="#4f46e5" />
    <title>Level Up Community Commands</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', '-apple-system','BlinkMacSystemFont','Segoe UI','Roboto','Helvetica','Arial','sans-serif']
                    },
                    boxShadow: {
                        'soft': '0 4px 18px -2px rgb(0 0 0 / 0.07)'
                    },
                    animation: {
                        'fade-in': 'fadeIn .5s ease-out',
                        'scale-in': 'scaleIn .35s ease-out'
                    },
                    keyframes: {
                        fadeIn: { '0%':{opacity:0}, '100%':{opacity:1}},
                        scaleIn: { '0%':{opacity:0, transform:'scale(.96)'}, '100%':{opacity:1, transform:'scale(1)'} }
                    }
                }
            }
        }
    </script>
    <style>
        :root {
            --grad-start:#4f46e5;
            --grad-end:#7c3aed;
        }
        .glass {
            background: linear-gradient(135deg, rgba(255,255,255,.75),rgba(255,255,255,.55));
            backdrop-filter: blur(12px);
        }
        .dark .glass {
            background: linear-gradient(135deg, rgba(30,41,59,.85), rgba(30,41,59,.65));
        }
        ::selection { background:#6366f1; color:#fff; }
        @media (prefers-reduced-motion: reduce){
            * { animation-duration: .01ms !important; animation-iteration-count:1 !important; transition-duration:.01ms !important; }
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
</head>
<body class="bg-gray-50 text-gray-900 dark:bg-gray-900 dark:text-gray-100 antialiased selection:bg-indigo-600 selection:text-white">
    <!-- Skip link -->
    <a href="#main" class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 focus:bg-indigo-600 focus:text-white focus:px-4 focus:py-2 focus:rounded-md">Skip to content</a>

    <!-- Header -->
    <header class="relative overflow-hidden">
        <div class="absolute inset-0 bg-[radial-gradient(circle_at_20%_20%,#818cf880,transparent_55%),radial-gradient(circle_at_80%_30%,#a78bfa70,transparent_60%),linear-gradient(135deg,var(--grad-start),var(--grad-end))] dark:opacity-90"></div>
        <div class="absolute inset-0 opacity-20 mix-blend-overlay dark:opacity-30" style="background-image: url('data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2440%22 height=%2240%22 fill=%22none%22 stroke=%22%23ffffff22%22><path d=%22M0 .5H40M.5 0V40%22/></svg>');"></div>
        <div class="relative max-w-7xl mx-auto px-4 pt-10 pb-20 text-center">
            <div class="flex justify-end">
                <button id="themeToggle" class="group inline-flex items-center gap-2 rounded-full px-4 py-2 text-xs font-semibold bg-white/20 dark:bg-white/10 text-white backdrop-blur-md ring-1 ring-white/40 dark:ring-white/20 hover:ring-white focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-white/70 transition">
                    <span id="themeToggleIcon" aria-hidden="true">üåô</span><span class="hidden sm:inline">Toggle theme</span>
                </button>
            </div>
            <h1 class="text-4xl sm:text-5xl font-extrabold tracking-tight text-white drop-shadow-sm mt-6">Level Up Community Commands</h1>
            <p class="mt-4 text-lg sm:text-xl text-indigo-100 max-w-2xl mx-auto font-medium">Javascript Collections for Level Up extension.</p>
        </div>
    </header>

    <main id="main" class="max-w-7xl mx-auto px-4 -mt-12 relative z-10">
        <!-- Statistics Section -->
        <section aria-labelledby="statsHeading" class="grid grid-cols-2 md:grid-cols-4 gap-4 sm:gap-6">
            <h2 id="statsHeading" class="sr-only">Platform statistics</h2>
            <div class="glass rounded-xl p-5 sm:p-6 shadow-soft ring-1 ring-black/5 dark:ring-white/10 flex flex-col gap-1.5 animate-fade-in">
                <div class="text-xs uppercase font-semibold tracking-wide text-indigo-600 dark:text-indigo-400">Collections</div>
                <div id="total-collections" class="text-2xl font-bold tabular-nums">-</div>
            </div>
            <div class="glass rounded-xl p-5 sm:p-6 shadow-soft ring-1 ring-black/5 dark:ring-white/10 flex flex-col gap-1.5 animate-fade-in">
                <div class="text-xs uppercase font-semibold tracking-wide text-indigo-600 dark:text-indigo-400">Commands</div>
                <div id="total-commands" class="text-2xl font-bold tabular-nums">-</div>
            </div>
            <div class="glass rounded-xl p-5 sm:p-6 shadow-soft ring-1 ring-black/5 dark:ring-white/10 flex flex-col gap-1.5 animate-fade-in">
                <div class="text-xs uppercase font-semibold tracking-wide text-indigo-600 dark:text-indigo-400">Contributors</div>
                <div id="total-users" class="text-2xl font-bold tabular-nums">-</div>
            </div>
            <div class="glass rounded-xl p-5 sm:p-6 shadow-soft ring-1 ring-black/5 dark:ring-white/10 flex flex-col gap-1.5 animate-fade-in">
                <div class="text-xs uppercase font-semibold tracking-wide text-indigo-600 dark:text-indigo-400 flex items-center gap-1">Auto-Verified</div>
                <div id="auto-checked" class="text-2xl font-bold tabular-nums">-</div>
            </div>
        </section>

        <!-- Search / Filters -->
        <section class="mt-12 glass rounded-2xl p-6 sm:p-8 shadow-soft ring-1 ring-black/5 dark:ring-white/10 animate-scale-in">
            <div class="flex flex-col gap-5">
                <div class="relative">
                    <span class="pointer-events-none absolute inset-y-0 left-4 flex items-center text-gray-400 dark:text-gray-500">üîç</span>
                    <input id="search-box" type="text" placeholder="Search by name, description, tag or author..."
                           class="w-full pl-11 pr-4 py-4 rounded-xl bg-white/70 dark:bg-slate-800/70 border border-gray-200 dark:border-slate-700/60 focus:bg-white dark:focus:bg-slate-800 focus:border-indigo-500 dark:focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 dark:focus:ring-indigo-500/30 transition shadow-sm placeholder:text-gray-400 dark:placeholder:text-gray-500" />
                </div>
                <div class="flex flex-wrap gap-3">
                    <select id="category-filter" class="px-3 py-2.5 rounded-lg bg-white/70 dark:bg-slate-800/70 border border-gray-200 dark:border-slate-700 text-sm font-medium text-gray-700 dark:text-gray-200 focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500 focus:border-indigo-500 hover:border-indigo-400 dark:hover:border-indigo-400 transition">
                        <option value="">All Categories</option>
                    </select>
                    <select id="author-filter" class="px-3 py-2.5 rounded-lg bg-white/70 dark:bg-slate-800/70 border border-gray-200 dark:border-slate-700 text-sm font-medium text-gray-700 dark:text-gray-200 focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500 focus:border-indigo-500 hover:border-indigo-400 dark:hover:border-indigo-400 transition">
                        <option value="">All Authors</option>
                    </select>
                    <select id="sort-filter" class="px-3 py-2.5 rounded-lg bg-white/70 dark:bg-slate-800/70 border border-gray-200 dark:border-slate-700 text-sm font-medium text-gray-700 dark:text-gray-200 focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500 focus:border-indigo-500 hover:border-indigo-400 dark:hover:border-indigo-400 transition">
                        <option value="newest">Newest First</option>
                        <option value="oldest">Oldest First</option>
                        <option value="name">Name A-Z</option>
                        <option value="commands">Most Commands</option>
                    </select>
                </div>
            </div>
        </section>

        <!-- Collections Grid -->
        <section id="collections-grid" class="mt-10 grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
            <!-- Skeletons -->
            <template id="skeleton-card">
                <div class="rounded-2xl bg-white/70 dark:bg-slate-800/70 ring-1 ring-black/5 dark:ring-white/10 p-6 animate-pulse space-y-4 shadow-soft">
                    <div class="h-5 bg-gray-200 dark:bg-slate-600 rounded w-3/4"></div>
                    <div class="h-3 bg-gray-200 dark:bg-slate-600 rounded w-1/2"></div>
                    <div class="h-3 bg-gray-200 dark:bg-slate-600 rounded w-full"></div>
                    <div class="h-3 bg-gray-200 dark:bg-slate-600 rounded w-5/6"></div>
                    <div class="flex gap-2 pt-2">
                        <div class="h-6 w-16 bg-gray-200 dark:bg-slate-600 rounded"></div>
                        <div class="h-6 w-14 bg-gray-200 dark:bg-slate-600 rounded"></div>
                    </div>
                    <div class="flex gap-2 pt-4">
                        <div class="h-9 flex-1 bg-gray-200 dark:bg-slate-600 rounded"></div>
                        <div class="h-9 flex-1 bg-gray-200 dark:bg-slate-600 rounded"></div>
                        <div class="h-9 flex-1 bg-gray-200 dark:bg-slate-600 rounded"></div>
                    </div>
                </div>
            </template>
            <div class="col-span-full flex flex-col gap-6" id="initial-loader"></div>
        </section>
    </main>

    <!-- Commands Modal -->
    <div id="commandsModal" class="hidden fixed inset-0 z-50">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm opacity-0 transition-opacity" id="modalOverlay"></div>
        <div class="relative max-w-5xl mx-auto my-10 px-4">
            <div class="bg-white dark:bg-slate-900 rounded-2xl shadow-2xl ring-1 ring-black/10 dark:ring-white/10 overflow-hidden opacity-0 translate-y-6 transition-all" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
                <div class="flex items-center justify-between px-6 sm:px-8 py-5 border-b border-gray-200 dark:border-slate-700">
                    <h2 id="modalTitle" class="text-xl font-semibold tracking-tight">Collection Commands</h2>
                    <button onclick="closeModal()" class="group p-2 rounded-md text-gray-500 dark:text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-400 focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500">
                        <span class="sr-only">Close</span>
                        ‚úï
                    </button>
                </div>
                <div id="modalBody" class="p-6 sm:p-8 max-h-[60vh] overflow-y-auto space-y-4 text-sm"></div>
                <div class="px-6 sm:px-8 py-4 bg-gray-50 dark:bg-slate-800/60 border-t border-gray-200 dark:border-slate-700 flex flex-col sm:flex-row gap-3 sm:items-center sm:justify-between">
                    <button id="copyCollectionBtn" class="inline-flex items-center gap-1.5 px-4 py-2 text-sm font-medium rounded-lg bg-indigo-600 text-white hover:bg-indigo-500 focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-indigo-500" title="Copy all commands in this collection">
                        <span>üìã</span><span>Copy Collection</span>
                    </button>
                    <button onclick="closeModal()" class="px-4 py-2 text-sm font-medium rounded-lg bg-gray-200 dark:bg-slate-700 text-gray-800 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-slate-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-indigo-500">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="mt-20 border-t border-gray-200 dark:border-slate-800">
        <div class="max-w-7xl mx-auto px-4 py-12 text-sm text-gray-600 dark:text-gray-400 flex flex-col sm:flex-row gap-4 sm:items-center justify-between">
            <p>Maintained by Natraj Yegnaraman.</p>
            <nav class="flex gap-5 font-medium">
                <a href="https://github.com/rajyraman/level-up-community-commands" class="hover:text-indigo-600 dark:hover:text-indigo-400 transition">GitHub Repo</a>
                <a href="https://microsoftedge.microsoft.com/addons/detail/level-up-for-dynamics-365/mdjlgdkgmhlmcikdmeehcecolehipicf" class="hover:text-indigo-600 dark:hover:text-indigo-400 transition">Extension</a>
            </nav>
        </div>
    </footer>

    <!-- Collection Card Template -->
    <template id="collection-card-template">
        <div class="group bg-white/80 dark:bg-slate-800/80 backdrop-blur-sm rounded-2xl shadow-soft ring-1 ring-gray-200/80 dark:ring-slate-700/60 overflow-hidden flex flex-col transition hover:shadow-lg hover:-translate-y-0.5 focus-within:ring-indigo-500 focus-within:ring-2">
            <div class="p-6 flex flex-col gap-4 flex-1">
                <div class="space-y-2">
                    <h3 class="collection-title text-lg font-semibold leading-snug text-gray-900 dark:text-white tracking-tight"></h3>
                    <div class="collection-author text-xs font-medium uppercase tracking-wide text-indigo-600 dark:text-indigo-400"></div>
                    <p class="collection-description text-sm text-gray-600 dark:text-gray-400 leading-relaxed line-clamp-4"></p>
                </div>
                <div class="collection-tags flex gap-2 flex-wrap pt-1"></div>
            </div>
            <div class="px-6 py-3 bg-gray-50 dark:bg-slate-800/60 border-t border-gray-200 dark:border-slate-700 text-[11px] text-gray-500 dark:text-gray-400 flex justify-between items-center">
                <div class="collection-stats flex gap-4 items-center font-medium"></div>
            </div>
            <div class="p-6 pt-4 flex gap-2 flex-wrap">
                <button class="view-btn flex-1 inline-flex items-center justify-center gap-1.5 px-4 py-2.5 rounded-lg text-xs font-semibold border border-indigo-500 text-indigo-600 dark:text-indigo-400 hover:bg-indigo-50 dark:hover:bg-indigo-500/10 focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-indigo-500 transition" title="View & Copy Collection">
                    <span>üëÅÔ∏è</span><span>View</span>
                </button>
                <a class="profile-link flex-1 inline-flex items-center justify-center gap-1.5 px-4 py-2.5 rounded-lg text-xs font-semibold bg-gray-100 dark:bg-slate-700/60 text-gray-700 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-slate-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-indigo-500 transition no-underline" target="_blank" rel="noopener" title="Author GitHub profile">
                    <span>üêô</span><span>Profile</span>
                </a>
            </div>
        </div>
    </template>

    <!-- Command Item Template -->
    <template id="command-item-template">
        <div class="border border-gray-200 dark:border-slate-700 rounded-xl overflow-hidden">
            <div class="bg-gray-50 dark:bg-slate-800/60 px-4 py-3 border-b border-gray-200 dark:border-slate-700">
                <div class="command-name font-medium text-gray-900 dark:text-white mb-0.5"></div>
                <div class="command-description text-xs text-gray-500 dark:text-gray-400"></div>
            </div>
            <pre class="command-code p-4 bg-gray-900 text-gray-100 text-xs leading-relaxed overflow-x-auto rounded-b-xl"><code></code></pre>
        </div>
    </template>

    <script>
        // Theme
        const root = document.documentElement;
        function applyStoredTheme(){
            const saved = localStorage.getItem('theme');
            if(saved === 'dark' || (!saved && window.matchMedia('(prefers-color-scheme: dark)').matches)){
                root.classList.add('dark');
            } else { root.classList.remove('dark'); }
            updateToggleIcon();
        }
        function toggleTheme(){
            const isDark = root.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            updateToggleIcon();
        }
        function updateToggleIcon(){
            const icon = document.getElementById('themeToggleIcon');
            if(icon) icon.textContent = root.classList.contains('dark') ? '‚òÄÔ∏è' : 'üåô';
        }
        document.addEventListener('DOMContentLoaded', () => {
            applyStoredTheme();
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
        });

        // Data state
        let allCollections = [];
        let filteredCollections = [];

        document.addEventListener('DOMContentLoaded', function() {
            createSkeletons();
            loadCollections();
            setupEventListeners();
        });

        function createSkeletons(){
            const loader = document.getElementById('initial-loader');
            for (let i=0;i<6;i++){
                const tpl = document.getElementById('skeleton-card').content.cloneNode(true);
                loader.appendChild(tpl);
            }
        }

        function setupEventListeners() {
            ['search-box','category-filter','author-filter','sort-filter'].forEach(id=>{
                const el = document.getElementById(id);
                if(!el) return;
                el.addEventListener(id==='search-box'?'input':'change', filterCollections);
            });
        }

        async function loadCollections() {
            try {
                const response = await fetch(`${collectionsBasePath}/index.json`, { cache: 'no-store' });
                const data = await response.json();
                updateStatistics(data);
                populateFilters(data);
                allCollections = data.recentCollections || [];
                filteredCollections = [...allCollections];
                renderCollections();
            } catch (error) {
                console.error('Failed to load collections:', error);
                showError('Failed to load collections. Please try again later.');
            }
        }

        // Determine base path for collections JSON files (works locally and on GitHub Pages where /docs is site root)
        const collectionsBasePath = (function(){
            // If running locally (served from docs/ via dev server) we need to go up one level to root collections folder
            if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
                return '../collections';
            }
            // On GitHub Pages (docs/ published as site root) collections folder must be copied under docs (or adjust build)
            return './collections';
        })();

        function updateStatistics(data) {
            document.getElementById('total-collections').textContent = data.totalCollections || 0;
            document.getElementById('total-commands').textContent = data.totalCommands || 0;
            document.getElementById('total-users').textContent = data.totalUsers || 0;
            const autoChecked = (data.recentCollections || []).filter(c => c.autoApproved !== false).length;
            document.getElementById('auto-checked').textContent = autoChecked;
        }

        function populateFilters(data) {
            const categoryFilter = document.getElementById('category-filter');
            const authorFilter = document.getElementById('author-filter');
            Object.keys(data.categories || {}).forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = `${category} (${data.categories[category]})`;
                categoryFilter.appendChild(option);
            });
            const authors = [...new Set((data.recentCollections || []).map(c => c.displayName || c.username))].sort();
            authors.forEach(author => {
                const option = document.createElement('option');
                option.value = author;
                option.textContent = author;
                authorFilter.appendChild(option);
            });
        }

        function filterByTag(tag) {
            document.getElementById('search-box').value = tag;
            document.getElementById('category-filter').value = '';
            document.getElementById('author-filter').value = '';
            filterCollections();
        }

        function filterCollections() {
            const searchTerm = document.getElementById('search-box').value.toLowerCase().trim();
            const categoryFilter = document.getElementById('category-filter').value;
            const authorFilter = document.getElementById('author-filter').value;
            const sortFilter = document.getElementById('sort-filter').value;

            filteredCollections = allCollections.filter(collection => {
                const matchesSearch = !searchTerm ||
                    [collection.name, collection.description, collection.category, (collection.displayName || collection.username)]
                        .filter(Boolean)
                        .some(v => v.toLowerCase().includes(searchTerm)) ||
                    (collection.tags || []).some(tag => tag.toLowerCase().includes(searchTerm));

                const matchesCategory = !categoryFilter || collection.category === categoryFilter;
                const matchesAuthor = !authorFilter || (collection.displayName || collection.username) === authorFilter;

                return matchesSearch && matchesCategory && matchesAuthor;
            });

            filteredCollections.sort((a, b) => {
                switch (sortFilter) {
                    case 'oldest': return new Date(a.submittedAt) - new Date(b.submittedAt);
                    case 'name': return a.name.localeCompare(b.name);
                    case 'commands': return b.commandCount - a.commandCount;
                    case 'newest':
                    default: return new Date(b.submittedAt) - new Date(a.submittedAt);
                }
            });

            renderCollections();
        }

        function renderCollections() {
            const grid = document.getElementById('collections-grid');
            const loader = document.getElementById('initial-loader');
            loader?.remove();
            if (filteredCollections.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center py-16 text-sm text-gray-500 dark:text-gray-400">No collections found. Adjust filters or try another search term.</div>';
                return;
            }
            grid.innerHTML = '';
            filteredCollections.forEach(collection => {
                grid.appendChild(createCollectionCard(collection));
            });
        }

        function createCollectionCard(collection) {
            const template = document.getElementById('collection-card-template');
            const card = template.content.cloneNode(true);
            const submittedDate = new Date(collection.submittedAt).toLocaleDateString();

            card.querySelector('.collection-title').textContent = collection.name;
            card.querySelector('.collection-author').textContent = (collection.displayName || collection.username);
            card.querySelector('.collection-description').textContent = collection.description || 'No description provided.';

            // Tags
            const tagsContainer = card.querySelector('.collection-tags');

            const categoryTag = document.createElement('button');
            categoryTag.type = 'button';
            categoryTag.className = 'px-2.5 py-1 rounded-md bg-amber-500 text-white text-[10px] font-semibold tracking-wide uppercase shadow hover:bg-amber-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-1 focus-visible:ring-amber-500 transition';
            categoryTag.textContent = collection.category;
            categoryTag.addEventListener('click', () => filterByTag(collection.category));
            tagsContainer.appendChild(categoryTag);

            (collection.tags || []).forEach(tag => {
                const tagBtn = document.createElement('button');
                tagBtn.type = 'button';
                tagBtn.className = 'px-2.5 py-1 rounded-md bg-indigo-100 text-indigo-700 dark:bg-indigo-500/15 dark:text-indigo-300 text-[10px] font-semibold tracking-wide uppercase hover:bg-indigo-200 dark:hover:bg-indigo-500/25 focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-1 focus-visible:ring-indigo-500 transition';
                tagBtn.textContent = tag;
                tagBtn.addEventListener('click', () => filterByTag(tag));
                tagsContainer.appendChild(tagBtn);
            });

            if (collection.autoApproved !== false) {
                const robotBadge = document.createElement('span');
                robotBadge.className = 'px-2.5 py-1 rounded-md bg-emerald-500 text-white text-[10px] font-semibold tracking-wide uppercase flex items-center gap-1 shadow';
                robotBadge.textContent = 'Auto-Verified';
                tagsContainer.appendChild(robotBadge);
            }

            // Stats
            const statsContainer = card.querySelector('.collection-stats');
            statsContainer.innerHTML = `
                <span class="flex items-center gap-1">üìä <span class="font-semibold">${collection.commandCount}</span></span>
                <span class="flex items-center gap-1">üìÖ ${submittedDate}</span>
            `;

            // Buttons
            const viewBtn = card.querySelector('.view-btn');
            const profileLink = card.querySelector('.profile-link');
            viewBtn.addEventListener('click', () => viewCommands(collection.username, collection.fileName, collection.name));
            profileLink.href = `https://github.com/${collection.username}`;
            profileLink.setAttribute('aria-label', `Open GitHub profile of ${(collection.displayName || collection.username)}`);

            return card;
        }

        // Current viewed collection state
        let currentViewedCollection = null;
        let currentViewedMeta = null;

        async function copyCurrentCollection(btn){
            if(!currentViewedCollection){
                feedback(btn, '‚ùå None', false); return;
            }
            try {
                const now = Date.now();
                const rand = () => Math.random().toString(36).slice(2,11);
                const normCode = c => (c||'').replace(/\\n/g,'\n');
                const mapped = (currentViewedCollection.commands || []).map(cmd => {
                    const created = cmd.createdAt || now;
                    const updated = cmd.updatedAt || created;
                    return {
                        name: cmd.name || '',
                        description: cmd.description || '',
                        code: normCode(cmd.code),
                        icon: cmd.icon || '',
                        id: cmd.id || `cmd_${created}_${rand()}`,
                        createdAt: created,
                        updatedAt: updated
                    };
                });
                const exportObj = {
                    version: '1.0.0',
                    exportedAt: now,
                    commands: mapped
                };
                const json = JSON.stringify(exportObj, null, 2);
                if(navigator.clipboard && window.isSecureContext){
                    await navigator.clipboard.writeText(json);
                } else {
                    const ta = document.createElement('textarea');
                    ta.value = json; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove();
                }
                feedback(btn, '‚úÖ Copied', true);
            } catch(err){
                console.error(err);
                feedback(btn, '‚ùå Error', false);
            }
        }

        function feedback(btn, text, success){
            if(!btn) return;
            if(!btn.dataset.origHtml){
                btn.dataset.origHtml = btn.innerHTML;
                btn.dataset.origClass = btn.className;
            }
            btn.innerHTML = text;
            // remove original bg/hover classes (simple regex)
            const cleaned = btn.dataset.origClass.replace(/bg-(?:indigo|emerald|red)-\d{3,4}\s?/g,'').replace(/hover:bg-(?:indigo|emerald|red)-\d{3,4}\s?/g,'');
            btn.className = cleaned + (success ? ' bg-emerald-600 hover:bg-emerald-500' : ' bg-red-600 hover:bg-red-500');
            btn.disabled = true;
            setTimeout(()=>{
                btn.innerHTML = btn.dataset.origHtml;
                btn.className = btn.dataset.origClass;
                btn.disabled = false;
            },1800);
        }

        async function viewCommands(username, fileName, collectionName) {
            try {
                const response = await fetch(`${collectionsBasePath}/${username}/collections/${fileName}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const collection = await response.json();
                currentViewedCollection = collection;
                currentViewedMeta = { username, collectionName };
                document.getElementById('modalTitle').textContent = `${collectionName} ‚Äì Commands`;
                const modalBody = document.getElementById('modalBody');
                modalBody.innerHTML = '';
                (collection.commands || []).forEach(cmd => modalBody.appendChild(createCommandItem(cmd)));
                openModal();
            } catch (error) {
                alert('Failed to load commands: ' + error.message);
            }
        }

        function createCommandItem(cmd) {
            const template = document.getElementById('command-item-template');
            const item = template.content.cloneNode(true);
            const normalizeDisplay = c => {
                if(!c) return '';
                return c
                    .replace(/\\n/g,'\n')
                    .replace(/\r?\n/g,'\n')
                    .replace(/\/n/g,'\n');
            };
            item.querySelector('.command-name').textContent = `${cmd.icon || 'üìÑ'} ${cmd.name}`;
            item.querySelector('.command-description').textContent = cmd.description || '';
            item.querySelector('.command-code code').textContent = normalizeDisplay(cmd.code);
            return item;
        }

        function openModal(){
            const modal = document.getElementById('commandsModal');
            modal.classList.remove('hidden');
            requestAnimationFrame(()=>{
                document.getElementById('modalOverlay').classList.remove('opacity-0');
                const panel = modal.querySelector('[role="dialog"]');
                panel.classList.remove('opacity-0','translate-y-6');
                panel.focus();
                const copyBtn = document.getElementById('copyCollectionBtn');
                if(copyBtn && !copyBtn.dataset.bound){
                    copyBtn.addEventListener('click', ()=> copyCurrentCollection(copyBtn));
                    copyBtn.dataset.bound = '1';
                }
            });
        }
        function closeModal() {
            const modal = document.getElementById('commandsModal');
            const overlay = document.getElementById('modalOverlay');
            const panel = modal.querySelector('[role="dialog"]');
            overlay.classList.add('opacity-0');
            panel.classList.add('opacity-0','translate-y-6');
            setTimeout(()=> modal.classList.add('hidden'), 200);
        }
        window.addEventListener('click', e => { if (e.target.id === 'modalOverlay') closeModal(); });
        document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

        function showError(message) {
            const grid = document.getElementById('collections-grid');
            grid.innerHTML = `<div class="col-span-full bg-red-100 dark:bg-red-500/10 text-red-700 dark:text-red-300 px-6 py-5 rounded-xl" role="alert">
                <div class="flex gap-4">
                    <div class="flex-shrink-0">
                        <!-- Heroicon name: mini/exclamation-triangle -->
                        <svg class="h-5 w-5 text-red-400 dark:text-red-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" aria-hidden="true">
                            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01M21.364 4.636a9 9 0 10-12.728 12.728M15 9l-6 6m0-6l6 6" />
                        </svg>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm font-medium text-red-800 dark:text-red-400">${message}</p>
                    </div>
                </div>
            </div>`;
        }
    </script>
</body>
</html>
